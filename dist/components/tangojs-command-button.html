<!DOCTYPE html>

<script type="text/javascript" src="../web-component-element.js"></script>
<script type="text/javascript" src="../tangojs-element.js"></script>

<script type="text/javascript">
(function (window) {
  'use strict'

  const WebComponentElement = window.WebComponentElement
  const document = window.document
  const tangojs = window.tangojs

  class TangoJsCommandButtonElement extends window.HTMLElement {

    createdCallback () {
      this.root = this.createShadowRoot()
      this.dom = this.createLocalDom()
      this.root.appendChild(this.dom.button)
      this.dom.button.onclick = (event) => this.onClick(event)
    }

    createLocalDom () {
      const button = document.createElement('button')
      const content = document.createElement('content')
      button.appendChild(content)
      return { button, content }
    }

    onModelChange (value) {
      const [_, devname, cmdname] = value.match(/^(.+)\/([A-Za-z0-9_]+)$/)
      this.proxy = new tangojs.proxy.CommandProxy(devname, cmdname)
    }

    onClick (event) {
      const devDataIn = new tangojs.struct.DeviceData(this.parameters)
      this.proxy.inout(devDataIn)
        .then(devDataOut => devDataOut.value)
        .then(value => {
          if (this.onresult && this.onresult.call) {
            this.onresult.call(this, value)
          }
        })
    }
  }

  WebComponentElement.wireAttributes(TangoJsCommandButtonElement.prototype, {
    model: {
      type: 'string',
      onChange: TangoJsCommandButtonElement.prototype.onModelChange
    },
    parameters: {
      type: 'object'
    },
    onresult: {
      type: ['function', 'event'],
      attribute: 'onresult'
    }
  })

  TangoJsElement.registerComponent(TangoJsCommandButtonElement,
                                   'tangojs-command-button')

})(window)

</script>
