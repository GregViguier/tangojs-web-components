<!DOCTYPE html>
<html>

<link rel="import" href="html-led-element.html">

<script type="text/javascript">
(function (window) {
  'use strict'

  const tangojs = window.tangojs

  class TangoJsStateLedElement extends window.HTMLElement {

    createdCallback () {
      this.root = this.createShadowRoot()
      this.dom = this.createLocalDom()
      this.root.appendChild(this.dom.grid)
    }

    createLocalDom () {
      const grid = this.createFormGrid()
      const dom = {
        name: this.createFormField('span', 1, 1),
        value: this.createFormField('span', 2, 2),
        /* {3rd,4th} element is not used */
        led: this.createFormField('x-led', 5, 1)
      }
      Object.keys(dom).forEach(node => grid.appendChild(dom[node]))
      dom.led.on = true
      dom.grid = grid
      return dom
    }

    createProxy (model) {
      return new tangojs.proxy.DeviceProxy(model)
    }

    readProxy (proxy) {
      return proxy.state()
    }

    updateName () {
      this.proxy[this.model].get_info().then(deviceInfo => {
        this.dom.name.textContent = deviceInfo.name
      })
    }

    onModelRead (states) {
      const devState = states[this.model]
      const [color, on] = this.getLedSetup(devState)
      this.dom.value.textContent = devState.key
      this.dom.led.color = color
      this.dom.led.on = on
    }

    getLedSetup (devState) {
      switch (devState) {
        case tangojs.tango.DevState.ON: return ['#80FF00', true]
        case tangojs.tango.DevState.OFF: return ['#80FF00', false]
        case tangojs.tango.DevState.RUNNING: return ['#0080FF', true]
        case tangojs.tango.DevState.FAULT: return ['#FF0000', true]
        case tangojs.tango.DevState.ALARM: return ['#FF8000', true]
        default: return ['#FF00FF', true]
      }
    }

    onShowLedChange (showLed) {
      this.dom.led.style.display = showLed ? 'block' : 'none'
    }

    onShowNameChange (showName) {
      this.dom.name.style.display = showName ? 'block' : 'none'
    }
  }

  window.tangojs.web.util.mixins.withPolledModel.call(
    TangoJsStateLedElement.prototype)
  window.tangojs.web.util.mixins.withFormElement.call(
    TangoJsStateLedElement.prototype)

  window.tangojs.web.util.WebComponentElement.wireAttributes(
    TangoJsStateLedElement.prototype,
    {
      model: {
        type: 'string',
        onChange: function (model) {
          if (!model) return
          this.onModelChange(model)
          this.updateName()
        }
      },
      pollPeriod: {
        type: 'number',
        onChange: TangoJsStateLedElement.prototype.onPollPeriodChange
      },
      showLed: {
        type: 'boolean',
        onChange: TangoJsStateLedElement.prototype.onShowLedChange
      },
      showName: {
        type: 'boolean',
        onChange: TangoJsStateLedElement.prototype.onShowNameChange
      }
    })

  window.tangojs.web.util.registerComponent('tangojs-state-led',
                                             TangoJsStateLedElement)

})(window)

</script>

</html>
