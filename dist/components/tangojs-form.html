<!DOCTYPE html>
<html>

<script type="text/javascript">
(function (window) {
  'use strict'

  const document = window.document

  const groupBy = window.tangojs.web.util.fn.groupBy

  function groupByDeviceModel (modelArray) {
    return groupBy(modelArray, model => model.split('/').slice(0, 3).join('/'))
  }

  function getTagsFromGroupingEntry ([deviceModel, models]) {
    if (models.length === 1 && models[0].split('/').length === 3) {
      return Promise.resolve({ [models[0]]: 'tangojs-state-led' })
    } else {
      const proxy = new window.tangojs.proxy.DeviceProxy(deviceModel)
      const attPromise = proxy.get_attribute_info()
      const cmdPromise = proxy.command_list_query()
      return Promise.all([attPromise, cmdPromise]).then(([atts, cmds]) => {
        return models.reduce((tagMap, model) => {
          const modelParts = model.split('/')
          if (modelParts.length == 3) {
            tagMap[model] = 'tangojs-state-led'
          } else if (modelParts.length == 4) {
            const name = modelParts.slice(-1)[0]
            const attributeInfo = atts.find(x => x.name == name)
            if (attributeInfo) {
              switch (attributeInfo.writable) {
                case window.tangojs.tango.AttrWriteType.READ:
                  tagMap[model] = 'tangojs-label'
                  break
                case window.tangojs.tango.AttrWriteType.READ_WRITE:
                case window.tangojs.tango.AttrWriteType.READ_WITH_WRITE:
                  tagMap[model] = 'tangojs-line-edit'
                  break
              }
            } else {
              const commandInfo = cmds.find(x => x.cmd_name == name)
              if (commandInfo) {
                tagMap[model] = 'tangojs-command-button'
              }
            }
          }
          return tagMap
        }, {})
      })
    }
  }

  function getTagsFromModelList (modelList) {
    return Promise
      .all(groupByDeviceModel(modelList).map(getTagsFromGroupingEntry))
      .then(tagMapList => tagMapList.reduce((tagMap, tagMapForDevice) => {
        Object.assign(tagMap, tagMapForDevice)
        return tagMap
      }, {}))
  }

  function instantiateComponent (tagName, model) {
    const constructor = Object
      .values(window.tangojs.web.components)
      .find(c => c.descriptor.tag == tagName)
    if (constructor && constructor.descriptor) {
      const node = document.createElement(tagName)
      Object
        .entries(constructor.descriptor.attributes)
        .forEach(([propName, { defaultValue }]) => {
          node[propName] = defaultValue
        })
      node.model = model
      return node
    }
    return null
  }

  class TangoJsFormElement extends window.HTMLElement {

    createdCallback () {
      this.root = this.createShadowRoot()
      this.dom = this.createLocalDom()
      this.root.appendChild(this.dom.grid)
    }

    createLocalDom () {
      const grid = document.createElement('div')
      Object.assign(grid.style, {
        display: 'inline-grid',
        gridTemplateColumns: '1fr',
        gridAutoFlow: 'row'
      })
      const fields = []
      return { grid, fields }
    }

    onModelChange (modelArray) {
      if (!modelArray) {
        return
      }

      getTagsFromModelList(modelArray).then(tagMap => {
        this.disposeCurrentElements()
        this.dom.fields = Object
          .entries(tagMap)
          .map(([model, tag]) => instantiateComponent(tag, model))
        this.dom.fields.forEach(node => {
          this.dom.grid.appendChild(node)
        })
      })
    }

    onPollPeriodChange (pollPeriod) {
      this.dom.fields.forEach(node => {
        node.pollPeriod = pollPeriod
      })
    }

    disposeCurrentElements () {
      this.dom.fields.forEach(node => {
        this.dom.grid.removeChild(node)
      })
      this.dom.fields = []
    }
  }

  window.tangojs.web.util.mixins.withReflectedAttributes.call(
    TangoJsFormElement.prototype,
    {
      model: {
        type: [Array, String],
        onChange: TangoJsFormElement.prototype.onModelChange
      },
      pollPeriod: {
        type: Number,
        defaultValue: 1000,
        onChange: TangoJsFormElement.prototype.onPollPeriodChange
      }
    })

  window.tangojs.web.util.registerComponent('tangojs-form',
                                            TangoJsFormElement,
                                            {
                                              multipleModels: true,
                                              attributes: true,
                                              commands: true,
                                              status: true,
                                              readOnly: true
                                            },
                                            {
                                              model: {
                                                type: [Array, String],
                                                defaultValue: []
                                              },
                                              poolPeriod: {
                                                type: Number,
                                                defaultValue: 1000
                                              }
                                            })

})(window)

</script>

</html>
